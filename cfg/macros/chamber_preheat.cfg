

[gcode_macro CHAMBER_PREHEAT]
variable_sensor: 'temperature_sensor chamber'
variable_height: 15
variable_bed_temp: 118
variable_extruder_temps: {
  'PLA': 51,
  'PET': 60,
  'PETG': 60,
  'ABS': 70,
  'ASA': 70}
variable_fans: {
  'nevermore': 1}
gcode:
  {% if printer.toolhead.homed_axes|lower != 'xyz' %}
    { action_raise_error('Can\'t move to preheat position. Home first...') }
  {% endif %}

  {% if not sensor %}
    { action_raise_error('No sensor set.') }
  {% endif %}

  {% if sensor not in printer %}
    { action_raise_error('Defined \'%s\' sensor doesn\'t exist.' % (sensor)) }
  {% endif %}

  {% if 'S' in params %}
    {% set dummy = params.__setitem__('CHAMBER', params.S) %}
  {% endif %}

  {% set km = printer['gcode_macro _km_globals'] %}
  {% set CHAMBER = params.CHAMBER|default(0)|float %}
  {% set BED = params.BED|default(bed_temp)|float %}
  {% set MATERIAL = params.MATERIAL %}
  {% set WAIT = params.WAIT|default(0)|int %}
  {% set FANS_OFF = params.FANS_OFF|default(0)|int %}

  {% if CHAMBER > 0 %}
    RESPOND PREFIX="" MSG={ '"Start preheating chamber to %.0fC"' % ( CHAMBER ) }

    {% if BED > 0 %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ BED }
    {% endif %}

    {% if MATERIAL and MATERIAL in extruder_temps %}
      {% set extruder = extruder_temps[MATERIAL] %}
    {% else %}
      {% set extruder = extruder_temps['PLA'] %}
    {% endif %}

    {% for fan, speed in fans.items() %}
      SET_FAN_SPEED FAN={fan} SPEED={speed}
    {% endfor %}

    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder}
    M106 S176

    G0 Z{height} F{km.travel_speed_z}
    G0 X{printer.toolhead.axis_maximum.x / 2 | int} Y{printer.toolhead.axis_maximum.y / 2 | int} F{km.travel_speed_xy}

    {% if WAIT %}
      TEMPERATURE_WAIT SENSOR={ '"%s"' % ( sensor ) } MINIMUM={CHAMBER}
  
      RESPOND PREFIX="" MSG={ '"Chamber preheated to %.0fC"' % ( CHAMBER ) }
    {% endif %}
  {% endif %}

  {% if WAIT and FANS_OFF %}
    M106 S0

    {% for fan, speed in fans.items() %}
      SET_FAN_SPEED FAN={fan} SPEED=0
    {% endfor %}
  {% endif %}

[gcode_macro m191]
rename_existing: km_m191
gcode:
  CHAMBER_PREHEAT BED=110 {rawparams}

[gcode_macro m141]
rename_existing: km_m141
gcode:
  CHAMBER_PREHEAT BED=110 {rawparams}

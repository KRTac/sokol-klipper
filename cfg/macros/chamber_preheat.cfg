[gcode_macro M191]
rename_existing: M191.2
gcode:
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% set km = printer["gcode_macro _km_globals"] %}
    {% set CHAMBER = params.S|default(0)|float %}
    {% set BED = params.BED|default(0)|float %}

    {% if CHAMBER > 0 %}
      RESPOND PREFIX="" MSG={ '"Start preheating chamber to %.0fC"' % ( CHAMBER ) }

      {% if BED > 0 %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ BED }
      {% endif %}

      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=51
      M106 S155

      SAVE_GCODE_STATE NAME=START_CHAMBER_PREHEAT

      G90
      G0 Z15 F{km.travel_speed_z}
      G0 X140 Y115 F{km.travel_speed_xy}

      TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={CHAMBER}
      RESPOND PREFIX="" MSG={ '"Chamber preheated to %.0fC"' % ( CHAMBER ) }
      M106 S0

      RESTORE_GCODE_STATE NAME=START_CHAMBER_PREHEAT
    {% else %}
      M106 S0
    {% endif %}
  {% else %}
    { action_raise_error("Can't move to preheat position. Home first...") }
  {% endif %}

[gcode_macro M141]
rename_existing: M141.2
gcode:
  M191 {rawparams}
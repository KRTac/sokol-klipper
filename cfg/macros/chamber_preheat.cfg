

[gcode_macro chamber_preheat]
variable_sensor: 'temperature_sensor chamber'
variable_height: 15
variable_bed_temp: 118
variable_extruder_temps: {
  'PLA': 51,
  'PET': 60,
  'PETG': 60,
  'ABS': 70,
  'ASA': 70}
variable_fans: {
  'nevermore': 1}
gcode:
  {% if printer.toolhead.homed_axes|lower != 'xyz' %}
    { action_raise_error('Can\'t move to preheat position if needed. Home first...') }
  {% endif %}

  {% if not sensor %}
    { action_raise_error('No sensor set.') }
  {% endif %}

  {% if sensor not in printer %}
    { action_raise_error('The sensor \'%s\' doesn\'t exist.' % (sensor)) }
  {% endif %}

  {% if 'S' in params %}
    {% set dummy = params.__setitem__('TARGET', params.S) %}
  {% endif %}

  {% set km = printer['gcode_macro _km_globals'] %}
  {% set BED = params.BED|default(bed_temp)|float %}
  {% set MATERIAL = params.MATERIAL %}
  {% set TARGET = params.TARGET|default(0)|float %}
  {% set FANS_OFF = params.FANS_OFF|default(1 if TARGET > 0 else 0)|int %}
  {% set HEATERS_OFF = params.HEATERS_OFF|default(0)|int %}
  {% set current_temp = printer[sensor].temperature %}

  {% if TARGET > 0 and current_temp >= TARGET %}
    RESPOND PREFIX="" MSG={ '"Chamber already at %.1fC. Moving on without changes."' % ( current_temp ) }
  {% else %}
    {% if TARGET > 0 %}
      RESPOND PREFIX="" MSG={ '"Started preheating chamber to %.0fC."' % ( TARGET ) }
    {% endif %}

    {% if BED > 0 %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ BED }
    {% endif %}

    {% if MATERIAL and MATERIAL in extruder_temps %}
      {% set extruder = extruder_temps[MATERIAL] %}
    {% else %}
      {% set extruder = extruder_temps['PLA'] %}
    {% endif %}

    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder}
    M106 S176

    {% for fan, speed in fans.items() %}
      SET_FAN_SPEED FAN={fan} SPEED={speed}
    {% endfor %}

    G0 Z{height} F{km.travel_speed_z}
    G0 X{printer.toolhead.axis_maximum.x / 2 | int} Y{printer.toolhead.axis_maximum.y / 2 | int} F{km.travel_speed_xy}

    {% if TARGET > 0 %}
      TEMPERATURE_WAIT SENSOR="{sensor}" MINIMUM={TARGET}

      RESPOND PREFIX="" MSG={ '"Chamber preheated to %.0fC."' % ( TARGET ) }

      {% if HEATERS_OFF %}
        TURN_OFF_HEATERS
      {% endif %}
    {% else %}
      RESPOND PREFIX="" MSG="Started preheating."

      DISABLE_TIMEOUT
    {% endif %}

    {% if FANS_OFF %}
      M106 S0

      {% for fan, speed in fans.items() %}
        SET_FAN_SPEED FAN={fan} SPEED=0
      {% endfor %}
    {% endif %}
  {% endif %}

[gcode_macro M191]
rename_existing: M191.2
gcode:
  CHAMBER_PREHEAT {rawparams}

[gcode_macro M141]
rename_existing: M141.2
gcode:
  CHAMBER_PREHEAT {rawparams}

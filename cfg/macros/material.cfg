
[gcode_macro material]
variable_default: 'ASA'
variable_active: { 'name': '', 'extruder': 0, 'bed': 0 }
variable_list: [
  {
    'name' : 'ASA',
    'extruder': 255,
    'bed' : 107
  },
  {
    'name' : 'PLA',
    'extruder': 200,
    'bed' : 60
  },
  {
    'name' : 'ABS',
    'extruder': 250,
    'bed' : 100
  }]
gcode:
  {% set SET = params.SET|default('')|string %}

  {% if SET %}
    {% set active_material = { 'name': None, 'extruder': None, 'bed': None } %}
  
    {% for material in list %}
      {% if not active_material.name and material.name == SET %}
        {% set dummy = active_material.__setitem__('name', material.name) %}
        {% set dummy = active_material.__setitem__('extruder', material.extruder) %}
        {% set dummy = active_material.__setitem__('bed', material.bed) %}
      {% endif %}
    {% endfor %}
  
    {% if not active_material.name %}
      { action_raise_error('Active material %s not found.' % (SET))}
    {% endif %}
  
    SET_GCODE_VARIABLE MACRO=material VARIABLE=active VALUE="{active_material}"
    SAVE_VARIABLE VARIABLE=active_material VALUE="'{active_material.name}'"
  {% else %}
    RESPOND PREFIX="" MSG="{'Active: %s' % active.name}"
    RESPOND PREFIX="" MSG="{'Extruder: %.1fC' % active.extruder}"
    RESPOND PREFIX="" MSG="{'Bed: %.1fC' % active.bed}"
  {% endif %}

[delayed_gcode _material_init]
initial_duration: .1
gcode:
  {% set macro = printer['gcode_macro material'] %}
  {% set active_material_name = macro.default %}
  {% set active_material = { 'name': None, 'extruder': None, 'bed': None } %}

  {% if 'active_material' in printer.save_variables.variables %}
    {% set active_material_name = printer.save_variables.variables.active_material %}
  {% endif %}

  {% for material in macro.list %}
    {% if not active_material.name and material.name == active_material_name %}
      {% set dummy = active_material.__setitem__('name', material.name) %}
      {% set dummy = active_material.__setitem__('extruder', material.extruder) %}
      {% set dummy = active_material.__setitem__('bed', material.bed) %}
    {% endif %}
  {% endfor %}

  {% if not active_material.name %}
    { action_raise_error('Active material %s not found.' % (active_material_name))}
  {% endif %}

  SET_GCODE_VARIABLE MACRO=material VARIABLE=active VALUE="{active_material}"
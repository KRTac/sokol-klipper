[gcode_macro UNLOAD_FILAMENT]
rename_existing: KM_UNLOAD_FILAMENT
gcode:
  KM_UNLOAD_FILAMENT

  {% set km = printer['gcode_macro _km_globals'] %}
  {% set LENGTH = params.LENGTH|default(km.load_length)|float %}
  {% set SPEED = params.SPEED|default(km.load_speed)|int %}

  SAVE_GCODE_STATE NAME=_unload_state
  G0 E{'%.4f' % -LENGTH} F{SPEED}
  RESTORE_GCODE_STATE NAME=_unload_state
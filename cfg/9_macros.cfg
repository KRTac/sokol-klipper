[gcode_macro PRINT_START]
rename_existing: KM_PRINT_START
gcode:
  {% set BED = params.BED|float %}
  {% set EXTRUDER = params.EXTRUDER|float %}
  {% set km = printer["gcode_macro _km_globals"] %}
  {% set km_scaled_extruder = (km.start_extruder_preheat_scale * EXTRUDER)|round(0,'ceil')|int %}
  {% set clean_temp = (EXTRUDER * 0.8)|round(0,'ceil')|int %}

  {% if clean_temp < km_scaled_extruder %}
    {% set clean_temp = km_scaled_extruder %}
  {% endif %}

  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ BED }

  G28
  G1 X260 Y250 Z10 F2000

  { action_respond_info('Preheating extruder to %.0fC then dropping to %.0fC and cleaning the nozzle at %.0fC' % (EXTRUDER, km_scaled_extruder, clean_temp)) }
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={ EXTRUDER }
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={ EXTRUDER }
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={ km_scaled_extruder }

  G4 P2000

  SAVE_GCODE_STATE NAME=PRINT_START_STATE
  M83
  G1 E5 F180
  G1 E-2 F500
  RESTORE_GCODE_STATE NAME=PRINT_START_STATE

  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ clean_temp }
  CLEAN_NOZZLE
  G1 X140 Y115 Z50 F2500

  KM_PRINT_START {rawparams}

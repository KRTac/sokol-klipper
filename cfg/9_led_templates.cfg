[neopixel _led_flash_state]
pin: PB15
chain_count: 1
initial_red: 0
initial_green: 0
initial_blue: 0
initial_white: 0.2

[display_template _led_flash_state_template]
text:
  {% set mod = printer.system_stats.cputime % 1 %}
  {% set last = printer['neopixel _led_flash_state'].color_data[0][1]|default(0) %}
  {% set period = printer['neopixel _led_flash_state'].color_data[0][3]|default(0.2) %}

  {% if last == 0 %}
    {% set last = mod %}
  {% endif %}

  {% if last > mod %}
    {% set diff = (1 - last) + mod %}
  {% else %}
    {% set diff = mod - last %}
  {% endif %}

  {% if diff < period %}
    0, {last}, 0, {period}
  {% else %}
    1, 0, 0, {period}
  {% endif %}


[display_template sb_status_template]
text:
  {% set do_flash = printer['neopixel _led_flash_state'].color_data[0][0] %}
  {% if not printer['gcode_macro enable_timeout'].enabled and do_flash %}
    0.8, 0.8, 0.8, 0.8
  {% else %}
    {% if printer['gcode_macro PRINT_START'].fast_start %}
      0.72, 0.13, 0.6, 0.0
    {% else %}
      {% set settings = printer.configfile.settings['neopixel sb_leds'] %}
      { '%s, %s, %s, %s' % (settings.initial_red, settings.initial_green, settings.initial_blue, settings.initial_white) }
    {% endif %}
  {% endif %}

[display_template display_led_template]
text:
  {% if printer['gcode_macro PRINT_START'].fast_start %}
    0.72, 0.13, 0.6, 0.0
  {% else %}
    {% set settings = printer.configfile.settings['neopixel mini12864'] %}
    { '%s, %s, %s, %s' % (settings.initial_red, settings.initial_green, settings.initial_blue, settings.initial_white) }
  {% endif %}

[display_template display_knob_template]
text:
  {% set do_flash = printer['neopixel _led_flash_state'].color_data[0][0] %}
  {% if not printer['gcode_macro enable_timeout'].enabled and do_flash %}
    0.8, 0.8, 0.8, 0.8
  {% else %}
    0.1, 0.1, 0.1, 0.1
  {% endif %}


[delayed_gcode _set_display_templates]
initial_duration: .5
gcode:
  SET_LED_TEMPLATE LED=_led_flash_state TEMPLATE=_led_flash_state_template INDEX=1
  SET_LED_TEMPLATE LED=sb_leds TEMPLATE=sb_status_template INDEX=1
  SET_LED_TEMPLATE LED=mini12864 TEMPLATE=display_led_template INDEX=1
  SET_LED_TEMPLATE LED=mini12864 TEMPLATE=display_knob_template INDEX=2
  SET_LED_TEMPLATE LED=mini12864 TEMPLATE=display_knob_template INDEX=3

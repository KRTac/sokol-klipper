[gcode_button filament_sense]
pin: !PC5
press_gcode:
  _filament_inserted
release_gcode:
  _filament_gone

[gcode_button filament_unload]
pin: !PB0
press_gcode:
  _button_pressed
release_gcode:
  _button_released

[gcode_macro _button_pressed]
gcode:
  {% set km = printer['gcode_macro _km_globals'] %}
  {% set state = printer['gcode_macro filament_sensor'] %}
  {% set cputime = printer.system_stats.cputime %}
  {% set double_tap = 1 if cputime - state.double_tap_timestamp <= 0.2 else 0 %}
  {% set is_printing = 1 if printer.print_stats.state == 'printing' else 0 %}

  SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=button_press_timestamp VALUE={cputime}

  RESPOND PREFIX="" MSG="Button pressed"

  {% if state.unload_step >= 0 %}
    RESPOND PREFIX="" MSG="{'Unload step: %s' % state.unload_step}"

    {% if state.loaded %}
      {% if state.unload_step == 0 %}
        RESPOND PREFIX="" MSG="Unloading filament"

        UNLOAD_FILAMENT
      {% elif state.unload_step == 1 %}
        LOAD_FILAMENT

        {% if printer.pause_resume.is_paused %}
          RESPOND PREFIX="" MSG="Load filament, is paused"
          SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=2
        {% else %}
          RESPOND PREFIX="" MSG="Load filament, not paused"
          SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=-1
        {% endif %}
      {% else %}
        {% if printer.pause_resume.is_paused %}
          RESUME
          RESPOND PREFIX="" MSG="Resume step"
        {% else %}
          RESPOND PREFIX="" MSG="NO resume step"
        {% endif %}

        SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=-1
      {% endif %}
    {% else %}
      M117 Load filament first
      SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=1
      RESPOND PREFIX="" MSG="Filament not detected"
    {% endif %}

    SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=double_tap_timestamp VALUE=0
  {% else %}
    {% if state.loaded %}
      {% if double_tap %}
        RESPOND PREFIX="" MSG="Loaded double tap"
        SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=double_tap_timestamp VALUE=0
  
        {% if is_printing %}
          GCODE_AT_LAYER LAYER=next COMMAND="_start_unload" CANCEL=1
        {% endif %}
  
        _start_unload
      {% else %}
        RESPOND PREFIX="" MSG="Loaded normal tap"
        SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=double_tap_timestamp VALUE={cputime}
  
        {% if is_printing %}
          GCODE_AT_LAYER LAYER=next COMMAND="_start_unload"
        {% endif %}
      {% endif %}
    {% else %}
      {% if not is_printing and double_tap  %}
        RESPOND PREFIX="" MSG="Not loaded double tap"
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={km.load_min_temp}
        SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=1
      {% endif %}
    {% endif %}
  {% endif %}

[gcode_macro _button_released]
gcode:
  {% set state = printer['gcode_macro filament_sensor'] %}
  {% set cputime = printer.system_stats.cputime %}
  {% set long_press = 1 if cputime - state.button_press_timestamp > 0.55 else 0 %}

  {% if long_press %}
    RESPOND PREFIX="" MSG="Long press detected"
  {% endif %}

  {% if long_press and printer.print_stats.state == 'printing' %}
    RESPOND PREFIX="" MSG="Canceling print"
    CANCEL_PRINT
  {% endif %}

[gcode_macro _filament_inserted]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=loaded VALUE=1
  RESPOND PREFIX="" MSG="Filament detected"

[gcode_macro _filament_gone]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=loaded VALUE=0

  {% if printer.print_stats.state == 'printing' %}
    _start_unload
  {% endif %}
  RESPOND PREFIX="" MSG="Filament missing"

[gcode_macro _start_unload]
gcode:
  {% set state = printer['gcode_macro filament_sensor'] %}
  {% if state.unload_step == -1 %}
    SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=unload_step VALUE=0

    {% if printer.print_stats.state == 'printing' %}
      PAUSE
    {% endif %}
  {% endif %}

[gcode_macro filament_sensor]
variable_loaded: 0
variable_unload_step: -1
variable_double_tap_timestamp: 0
variable_button_press_timestamp: 0
gcode:
  { action_respond_info('Filament detected: %s' % ('yes' if loaded else 'no')) }

[delayed_gcode _filament_sensor_init]
initial_duration: 1
gcode:
  {% set loaded = 1 if printer['gcode_button filament_sense'].state == 'PRESSED' else 0 %}
  RESPOND PREFIX="" MSG="{'initial filament state: %s' % ('loaded' if loaded else 'empty')}"
  SET_GCODE_VARIABLE MACRO=filament_sensor VARIABLE=loaded VALUE={loaded}
